# 영속성 컨텍스트

- 엔티티를 영구 저장하는 환경
- 논리적인 개념이며 눈이 보이지 않는다
- 엔티티 매니저를 통해서 영속성 컨텍스트에 접근 한다

### 엔티티의 생명주기
- 비영속 (new / transient)
    - 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태
        - JPA 에 관계 없이 그냥 객체만 생성 한 상태
- 영속 (managed)
    - 영속성 컨텍스트에 관리되는 상태
        - 객체를 생성 한 후, 엔티티 매니저에 persist 해서 객체를 저장한 상태
        - DB에 저장 된 상태는 아니고 영속성 컨텍스트에 관리 되는 상태
        - 트랜잭션에 commit 할때 DB 에 쿼리가 날아간다
- 준영속 (detached)
    - 영속성 컨텍스트에 저장되었다가 분리된 상태
        - ex: em.detach(member)
        - 회원 엔티티를 영속성 컨텍스트에서 분리, 준영속 상태
- 삭제 (removed)
    - 삭제된 상태
        - ex: em.remove(member)
        - DB 삭제를 요청 하는 상태
        
### 이점
- 1차 캐시
    - 조회 할 때, DB를 뒤지는게 아니고 1차 캐시에서 조회 후 결과를 준다
    - 1차 캐시에 없을 때에는 DB 조회 후, 1차 캐시에 저장 후 반환
    - 트랜잭션 단위로 만들기 때문에 큰 이점은 없음
- 동일성 보장
- 트랜잭션을 지원하는 쓰기 지연
    - 1차 캐시에 저장 하고, 분석 하여 쿼리를 생성만 하고 commit 할때 쿼리가 실행 됨
    - property name="hibernate.jdbc.batch_size" value="10" 옵션을 통해서 쿼리를 한번에 실행 할 수 있다
- 변경 감지
    - 데이터를 찾아와서 변경하게 되면 persist 하지 않아도 Collection 처럼 업데이트가 된다
- 지연 로딩

